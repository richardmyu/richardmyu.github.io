<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favcion-apple.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/highlight/atom-one-dark.min.css">

<link rel="stylesheet" href="https://fonts.geekzu.org/css?family=EB+Garamond:300,300italic,400,400italic,700,700italic%7CCinzel+Decorative:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CSource+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"richardmyu.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":240,"offset":12,"width":320},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":null,"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="https://richardmyu.github.io/posts/fb53055d/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://richardmyu.github.io/posts/fb53055d/","path":"posts/fb53055d/","title":"Hexo + Next - 个人博客配置问题"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo + Next - 个人博客配置问题 | Serendipity</title>
  







<link href="https://fonts.loli.net/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet">

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Serendipity</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">悟已往之不谏，知来者之可追</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yum"
      src="https://raw.githubusercontent.com/richardmyu/gallery/1.0.0/avat/avatar_min.jpg">
  <p class="site-author-name" itemprop="name">yum</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/richardmyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;richardmyu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/9646027/yum-3fe" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;9646027&#x2F;yum-3fe" rel="noopener me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://richardmyu.github.io/posts/fb53055d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/richardmyu/gallery/1.0.0/avat/avatar_min.jpg">
      <meta itemprop="name" content="yum">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serendipity">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Hexo + Next - 个人博客配置问题 | Serendipity">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hexo + Next - 个人博客配置问题
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 21:33:09" itemprop="dateCreated datePublished" datetime="2021-01-01T21:33:09+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-11 20:51:50" itemprop="dateModified" datetime="2025-06-11T20:51:50+08:00">2025-06-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>记录 Hexo + Next 搭建博客过程中遇到的一些配置和问题。</p>
<span id="more"></span>
<h2 id="gulp-安装更新">1.<strong>gulp</strong> 安装更新</h2>
<p>执行 <code>hexo g</code>
之后生成的代码，结构比较乱，空格空行都很多，使用 <code>gulp</code>
进行压缩，以获取更快的加载速度。</p>
<p>旧版本 HEXO 的安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install -g gulp</span><br></pre></td></tr></table></figure>
<p>新版本 HEXO（5.x） 安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install gulp-cli -g</span><br><span class="line">npm install gulp -D</span><br></pre></td></tr></table></figure>
<blockquote>
<p>越来越多的人认同的一个共识是：最好不要全局安装项目所需要的依赖。
这主要是由于这些依赖不会显示在项目的依赖项列表中，如果要共享代码，则意味着您需要明确声明您的项目具有的依赖项超出了依赖文件本身。使问题更加复杂的是，您可能将项目搁置一段时间，然后将全局软件包安装更新为与项目中使用的版本不兼容的某个新版本，从而在重新访问该项目时引起冲突。据我了解，<code>gulp-cli</code>
直接解决了这些问题，因为它允许您通过提供 shell 访问来运行 gulp
的本地安装，就好像它是全局安装一样。 <a
target="_blank" rel="noopener" href="https://teamtreehouse.com/community/gulp-global-install-gulp-vs-gulpcli">Gulp
global install - gulp vs gulp-cli</a></p>
</blockquote>
<blockquote>
<p><a
target="_blank" rel="noopener" href="https://stackoverflow.com/questions/35571679/what-does-gulp-cli-stands-for">what
does gulp-“cli” stands for?</a></p>
</blockquote>
<p><strong>语法问题</strong></p>
<p>注意 gulp 语法（对于 4.x 版本而言）已经更新的问题：</p>
<p>旧版本：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//JS压缩</span></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;uglify&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.<span class="title function_">src</span>(<span class="string">&#x27;./public/**/*.js&#x27;</span>)</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">uglify</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>新版本（4.0.2）语法：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">miniJs</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">pipeline</span>(</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&#x27;./public/**/*.js&#x27;</span>),</span><br><span class="line">    <span class="title function_">uglify</span>(),</span><br><span class="line">    <span class="title function_">dest</span>(<span class="string">&#x27;./public&#x27;</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一部分，可能随着时间推移，这里说的也会有问题，总之记得去官网看语法。</p>
<h2 id="图片模块安装更新">2.图片模块安装更新</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install gulp-htmlclean gulp-htmlmin gulp-minify-css gulp-uglify gulp-imagemin --save</span><br></pre></td></tr></table></figure>
<p>这些都是开发依赖，应该放到 <code>devDependencies</code> 中去：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install gulp-htmlclean gulp-htmlmin gulp-minify-css gulp-imagemin --save-dev</span><br><span class="line"># or</span><br><span class="line">npm install gulp-htmlclean gulp-htmlmin gulp-minify-css gulp-imagemin -D</span><br></pre></td></tr></table></figure>
<p>注意，我把其中的 <code>gulp-uglify</code>
拿出来没有安装，是因为如果压缩的 JavaScript 代码涉及到某些 ES6
语法时，会因语法问题而无法成功压缩，可以使用 <code>gulp-uglify-es</code>
解决这个问题。</p>
<blockquote>
<p><code>gulp-uglify</code> 的问题可以见 <a
target="_blank" rel="noopener" href="https://github.com/richardmyu/Blog/issues/16">gulp 压缩之
gulp-uglify #16</a></p>
</blockquote>
<h2 id="gulp-imagemin-模块部分规则更新">3.<code>gulp-imagemin</code>
模块部分规则更新</h2>
<p><code>jpegtran</code> 没有了，需要用 <code>mozjpeg</code> 代替。</p>
<p>同样也是因为版本更新，部分参数或方法以发生变化，总之，若有问题，先参考官网。<a
target="_blank" rel="noopener" href="https://www.npmjs.com/package/gulp-imagemin">更多细节</a></p>
<h2 id="图片">4.图片</h2>
<p>1.使用 PS 压缩图片； 2.使用图床或 CDN
来加载图片，而不是放在博客自身目录下（主要就是 Github 访问慢...）;
3.我选择的 Next 主题有内置的图片懒加载，修改即可；</p>
<h2 id="锚点失效">5.锚点失效</h2>
<p>不确定是不是更换了 <code>hexo-renderer-markdown-it</code>
造成的问题，只记得一开始锚点有效的，后来偶然发现锚点失效了，经查看页面源码，发现是标题渲染没有
<code>id</code> 属性。</p>
<p>在阅读 <a target="_blank" rel="noopener" href="https://convivae.top/posts/hexo-bo-ke-cai-keng/">Hexo
博客踩坑</a> 一文后，增加对这个问题的认识。基于 Less is More
的原则，决定不采用增添插件，修改源码的方式了。既然渲染引擎没法正常给标题的添加
<code>id</code>
属性，咱们自己手动给它加上不就好了吗:stuck_out_tongue_winking_eye:？</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section">### 1.引言</span></span><br><span class="line"></span><br><span class="line">// 看，相对于来增加插件来说，这样不是更简单</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">id</span>=<span class="string">&quot;引言&quot;</span>&gt;</span></span>1.引言<span class="language-xml"><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="spawn-failed">6.Spawn failed</h2>
<blockquote>
<p>2021/03/31</p>
</blockquote>
<p>今天更新了一下相册，最后推送的时候，爆出了这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Connection reset by xxx.xxx.xxx.xxx port 22</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: Error: Spawn failed</span><br><span class="line">      at ChildProcess.&lt;anonymous&gt; (D:\xx\...\node_modules\hexo-deployer-git\node_modules\hexo-util\lib\spawn.js:51:21)</span><br><span class="line">      at ChildProcess.emit (events.js:210:5)</span><br><span class="line">      at ChildProcess.cp.emit (D:\xx\...\node_modules\cross-spawn\lib\enoent.js:34:29)</span><br><span class="line">      at Process.ChildProcess._handle.onexit (internal/child_process.js:272:12) &#123;</span><br><span class="line">    code: 128</span><br><span class="line">  &#125;</span><br><span class="line">&#125; Something&#x27;s wrong. Maybe you can find the solution here: %s https://hexo.io/docs   s/troubleshooting.html</span><br></pre></td></tr></table></figure>
<p>之前没见过这类报错，于是就查查 <code>Spawn failed</code>
使什么问题导致的。（虽然不知道具体报错原因，但直觉是网络链接问题，多试几次就好了。。。）</p>
<p>后面试了两次并没有好转，同时也在查这个问题，网页上看到的都是说删除什么什么文件，感觉不靠谱，于是我再试了一次，这一次正常推送了。再反过头看那些回答，基本都只会告诉你怎么解决，但没有一个可以告诉你原因是什么。。。这就很迷！</p>
<p>其实想想，各种 “bug“
可能会出得奇奇怪怪，但至少还有有一定逻辑因素的。之前正常，突然冒出的问题，在“环境”没有变化的情况下，那大概最大可能就是网络问题了。（同样，在没有查出这个报错问题的我来说，也不一定就是正确的）</p>
<h2 id="置顶功能">7.置顶功能</h2>
<blockquote>
<p>2021/06/20</p>
</blockquote>
<p>最近想着弄一个文章置顶，然后发现网上的方法还是好几年前，并且
<code>hexo-generator-index</code> 早已更新到 2.0
版本了，估计不靠谱。于是自己去看了看源码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pagination = <span class="built_in">require</span>(<span class="string">&#x27;hexo-pagination&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; sort &#125; = <span class="built_in">require</span>(<span class="string">&#x27;timsort&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">locals</span>) &#123;  </span><br><span class="line">  <span class="keyword">const</span> config = <span class="variable language_">this</span>.<span class="property">config</span>;  </span><br><span class="line">  <span class="keyword">const</span> posts = locals.<span class="property">posts</span>.<span class="title function_">sort</span>(config.<span class="property">index_generator</span>.<span class="property">order_by</span>);</span><br><span class="line">  <span class="title function_">sort</span>(posts.<span class="property">data</span>, (a, b) =&amp;gt; (b.<span class="property">sticky</span> || <span class="number">0</span>) - (a.<span class="property">sticky</span> || <span class="number">0</span>));</span><br><span class="line">  <span class="keyword">const</span> paginationDir = config.<span class="property">pagination_dir</span> || <span class="string">&#x27;page&#x27;</span>;  </span><br><span class="line">  <span class="keyword">const</span> path = config.<span class="property">index_generator</span>.<span class="property">path</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">pagination</span>(path, posts, &#123;    </span><br><span class="line">    <span class="attr">perPage</span>: config.<span class="property">index_generator</span>.<span class="property">per_page</span>,    </span><br><span class="line">    <span class="attr">layout</span>: [<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;archive&#x27;</span>],    </span><br><span class="line">    <span class="attr">format</span>: paginationDir + <span class="string">&#x27;/%d/&#x27;</span>,    </span><br><span class="line">    <span class="attr">data</span>: &#123;<span class="attr">__index</span>: <span class="literal">true</span>&#125;&#125;);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>注意
<code>sort(posts.data, (a, b) =&amp;gt; (b.sticky || 0) - (a.sticky || 0));</code>
这行代码，感觉是用 <code>sticky</code>
作为置顶的关键字，比数值大小定顺序，若没有指定，则赋值为
0，进行日期比较；同样逻辑，若是 <code>sticky</code>
一样大，也是比较日期。</p>
<p>随便选取两篇文章，第一篇（日期在前）先设
<code>sticky: 1</code>，然后文章置顶，然后选第二篇设置
<code>stickty</code>，预期之内:smile::smile:，同样置顶，且在第一篇前面。</p>
<h2 id="optipng-bin-gifsicle">8.<code>optipng-bin</code> &amp;
<code>gifsicle</code></h2>
<blockquote>
<p>2021/10/28</p>
</blockquote>
<p>在 ubuntu 系统再装博客，安装 <code>hexo</code> 和 <code>gulp</code>
过程中，发现了这个问题。</p>
<p>具体：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ubuntu 20.04.3 LTS x86_64</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node v14.18.1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">npm 6.14.15</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">npm config get registry https://registry.npm.taobao.org/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">optipng-bin@6.0.0 postinstall /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/optipng-bin</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">node lib/install.js</span></span><br><span class="line"></span><br><span class="line">  ⚠ unable to verify the first certificate</span><br><span class="line">  ⚠ optipng pre-build test failed</span><br><span class="line">  ℹ compiling from source</span><br><span class="line">  ✖ Error: Command failed: /bin/sh -c ./configure --with-system-zlib --prefix=&quot;/home/ym/Documents/gitproject/richardmyu.github.io/node_modules/optipng-bin/vendor&quot; --bindir=&quot;/home/ym/Documents/gitproject/richardmyu.github.io/node_modules/optipng-bin/vendor&quot;</span><br><span class="line"></span><br><span class="line">Checking for gcc...</span><br><span class="line">Using pre-configured libpng...</span><br><span class="line">Checking for system zlib...</span><br><span class="line">./configure: error: missing zlib or incorrect zlib version</span><br><span class="line">./configure: note: zlib version 1.2.1 or higher is required</span><br><span class="line"></span><br><span class="line">    at /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/bin-build/node_modules/execa/index.js:231:11</span><br><span class="line">    at runMicrotasks (&lt;anonymous&gt;)</span><br><span class="line">    at processTicksAndRejections (internal/process/task_queues.js:95:5)</span><br><span class="line">    at async Promise.all (index 0)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">gifsicle@5.1.0 postinstall /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/gifsicle</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">node lib/install.js</span></span><br><span class="line"></span><br><span class="line">  ⚠ unable to verify the first certificate</span><br><span class="line">  ⚠ gifsicle pre-build test failed</span><br><span class="line">  ℹ compiling from source</span><br><span class="line">  ✖ Error: Command failed: /bin/sh -c autoreconf -ivf</span><br><span class="line">/bin/sh: 1: autoreconf: not found</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    at /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/bin-build/node_modules/execa/index.js:231:11</span><br><span class="line">    at processTicksAndRejections (internal/process/task_queues.js:95:5)</span><br><span class="line">    at async Promise.all (index 0)</span><br></pre></td></tr></table></figure>
<p><strong>错误关键词</strong></p>
<p><strong>optpng-bin</strong>、<strong>zlib</strong>、<strong>gifsicle</strong>、<strong>autoreconf</strong></p>
<p><strong>错误语句</strong></p>
<ul>
<li><code>Error: Command failed: /bin/sh -c ./configure --with-system-zlib ...</code></li>
<li><code>./configure: error: missing zlib or incorrect zlib version</code></li>
<li><code>Error: Command failed: /bin/sh -c autoreconf -ivf</code></li>
<li><code>/bin/sh: 1: autoreconf: not found</code></li>
</ul>
<p><strong>其他提示信息</strong></p>
<ul>
<li><code>unable to verify the first certificate</code></li>
<li><code>optipng/gifsicle pre-build test failed</code></li>
<li><code>./configure: note: zlib version 1.2.1 or higher is required</code></li>
</ul>
<h4 id="解决-unable-to-verify-the-first-certificate">1.解决
<code>unable to verify the first certificate</code></h4>
<p>造成这个问题，是因为使用了代理。</p>
<p>1.然而在关闭代理后（也清除了 <code>config</code>
内的代理配置信息），依旧没有成功，报如下错：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">connect ECONNREFUSED 0.0.0.0:443</span><br></pre></td></tr></table></figure>
<p>2.使用代理，并设置 <code>strict-ssl=false</code></p>
<p>事实上，我的 <code>npm config</code> 已经设置了
<code>strict-ssl=false</code>，然而并没有解决问题。</p>
<h4
id="missing-zlib-or-incorrect-zlib-version-autoreconf-not-found">2.<code>missing zlib or incorrect zlib version</code>
&amp; <code>autoreconf: not found</code></h4>
<p>这两个在系统里确实没有，我们可以试着安装一下，但我觉得不是这个的原因。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">autoreconf -- autoconf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zlib       -- zlib1g</span></span><br><span class="line">sudo apt install zlib1g autoconf</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不要安装了，因为安装了作用没体现，反而卸载的时候，绑定了许多重要的基础包：</p>
<p>【警告】：下列基础软件包将被卸载。
请勿尝试，除非您确实知道您在做什么！ apt adduser (是由于 apt) gpgv
(是由于 apt) libapt-pkg6.0 (是由于 apt) dash dpkg (是由于 dash) debconf
(是由于 dash) zlib1g (是由于 dpkg) grep install-info (是由于 grep) gzip
init systemd-sysv (是由于 init) init-system-helpers (是由于 init)
perl-base (是由于 init-system-helpers) login libpam0g (是由于 login)
libpam-runtime (是由于 login) libpam-modules (是由于 login) mount
util-linux (是由于 mount) shim-signed grub-efi-amd64-signed (是由于
shim-signed) grub2-common (是由于 shim-signed) mokutil (是由于
shim-signed) sbsigntool (是由于 shim-signed) sysvinit-utils</p>
</blockquote>
<p>安装后的结果：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">gifsicle@5.2.1 postinstall /home/ym/Documents/gitProject/richardmyu.github.io/node_modules/gifsicle</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">node lib/install.js</span></span><br><span class="line">    unable to verify the first certificate</span><br><span class="line">    gifsicle pre-build test failed</span><br><span class="line">    compiling from source</span><br><span class="line">    Error: Command failed: /bin/sh -c autoreconf -ivf</span><br><span class="line">    autoreconf: Entering directory `.&#x27;</span><br><span class="line">    autoreconf: configure.ac: not using Gettext</span><br><span class="line">    autoreconf: running: aclocal  --output=aclocal.m4t</span><br><span class="line">    Can&#x27;t exec &quot;aclocal&quot;: 没有那个文件或目录 at /usr/share/autoconf/Autom4te/FileUtils.pm line 326.</span><br><span class="line">    autoreconf: failed to run aclocal: No such file or directory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    at /home/ym/Documents/gitProject/richardmyu.github.io/node_modules/bin-build/node_modules/execa/index.js:231:11</span><br><span class="line">    at processTicksAndRejections (internal/process/task_queues.js:95:5)</span><br><span class="line">    at async Promise.all (index 0)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">mozjpeg@6.0.1 postinstall /home/ym/Documents/gitProject/richardmyu.github.io/node_modules/mozjpeg</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">node lib/install.js</span></span><br><span class="line"></span><br><span class="line">  ⚠ unable to verify the first certificate</span><br><span class="line">  ⚠ mozjpeg pre-build test failed</span><br><span class="line">  ℹ compiling from source</span><br><span class="line">  ✖ RequestError: unable to verify the first certificate</span><br><span class="line">    at ClientRequest.&lt;anonymous&gt; (/home/ym/Documents/gitProject/richardmyu.github.io/node_modules/got/index.js:111:21)</span><br><span class="line">    at Object.onceWrapper (events.js:520:26)</span><br><span class="line">    at ClientRequest.emit (events.js:400:28)</span><br><span class="line">    at TLSSocket.socketErrorListener (_http_client.js:475:9)</span><br><span class="line">    at TLSSocket.emit (events.js:400:28)</span><br><span class="line">    at emitErrorNT (internal/streams/destroy.js:106:8)</span><br><span class="line">    at emitErrorCloseNT (internal/streams/destroy.js:74:3)</span><br><span class="line">    at processTicksAndRejections (internal/process/task_queues.js:82:21)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">optipng-bin@6.0.0 postinstall /home/ym/Documents/gitProject/richardmyu.github.io/node_modules/optipng-bin</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">node lib/install.js</span></span><br><span class="line"></span><br><span class="line">  ⚠ unable to verify the first certificate</span><br><span class="line">  ⚠ optipng pre-build test failed</span><br><span class="line">  ℹ compiling from source</span><br><span class="line">  ✖ Error: Command failed: /bin/sh -c ./configure --with-system-zlib --prefix=&quot;/home/ym/Documents/gitProject/richardmyu.github.io/node_modules/optipng-bin/vendor&quot; --bindir=&quot;/home/ym/Documents/gitProject/richardmyu.github.io/node_modules/optipng-bin/vendor&quot;</span><br><span class="line"></span><br><span class="line">Checking for gcc...</span><br><span class="line">Using pre-configured libpng...</span><br><span class="line">Checking for system zlib...</span><br><span class="line">./configure: error: missing zlib or incorrect zlib version</span><br><span class="line">./configure: note: zlib version 1.2.1 or higher is required</span><br><span class="line"></span><br><span class="line">    at /home/ym/Documents/gitProject/richardmyu.github.io/node_modules/bin-build/node_modules/execa/index.js:231:11</span><br><span class="line">    at runMicrotasks (&lt;anonymous&gt;)</span><br><span class="line">    at processTicksAndRejections (internal/process/task_queues.js:95:5)</span><br><span class="line">    at async Promise.all (index 0)</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.2.13 (node_modules/glob-watcher/node_modules/fsevents):</span><br><span class="line">npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.13: wanted &#123;&quot;os&quot;:&quot;darwin&quot;,&quot;arch&quot;:&quot;any&quot;&#125; (current: &#123;&quot;os&quot;:&quot;linux&quot;,&quot;arch&quot;:&quot;x64&quot;&#125;)</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@2.1.3 (node_modules/fsevents):</span><br><span class="line">npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@2.1.3: wanted &#123;&quot;os&quot;:&quot;darwin&quot;,&quot;arch&quot;:&quot;any&quot;&#125; (current: &#123;&quot;os&quot;:&quot;linux&quot;,&quot;arch&quot;:&quot;x64&quot;&#125;)</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: gifsicle@5.2.1 (node_modules/gifsicle):</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: gifsicle@5.2.1 postinstall: `node lib/install.js`</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: Exit status 1</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: optipng-bin@6.0.0 (node_modules/optipng-bin):</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: optipng-bin@6.0.0 postinstall: `node lib/install.js`</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: Exit status 1</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>gifsicle</code>、<code>mozjpeg</code> 和
<code>optipng-bin</code> 的安装都出了问题，除了 <code>mozjpeg</code>
是证书问题，另外两个基本还是因为 <code>autoreconf</code> 和
<code>zlib</code>。</p>
<p>当我准备放弃的时候，又迎来的希望之光。</p>
<p>我升级了 <code>node</code>，到 <code>16.13.0</code>
版本，上述问题都没有了，没有了，没了。。。:smile:，但给了一堆警告：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm WARN old lockfile </span><br><span class="line">npm WARN old lockfile The package-lock.json file was created with an old version of npm,</span><br><span class="line">npm WARN old lockfile so supplemental metadata must be fetched from the registry.</span><br><span class="line">npm WARN old lockfile </span><br><span class="line">npm WARN old lockfile This is a one-time fix-up, please be patient...</span><br><span class="line">npm WARN old lockfile </span><br><span class="line">npm WARN deprecated gulp-minify-css@1.2.4: Please use gulp-clean-css</span><br><span class="line">npm WARN deprecated urix@0.1.0: Please see https://github.com/lydell/urix#deprecated</span><br><span class="line">npm WARN deprecated resolve-url@0.2.1: https://github.com/lydell/resolve-url#deprecated</span><br><span class="line">npm WARN deprecated gulp-util@3.0.8: gulp-util is deprecated - replace it, following the guidelines at https://medium.com/gulpjs/gulp-util-ca3b1f9f9ac5</span><br><span class="line">npm WARN deprecated fsevents@1.2.13: fsevents 1 will break on node v14+ and could be using insecure binaries. Upgrade to fsevents 2.</span><br><span class="line">npm WARN deprecated chokidar@2.1.8: Chokidar 2 will break on node v14+. Upgrade to chokidar 3 with 15x less dependencies.</span><br><span class="line">npm WARN deprecated querystring@0.2.0: The</span><br><span class="line">npm WARN deprecated svgo@1.3.2: This SVGO version is no longer supported. Upgrade to v2.x.x.</span><br><span class="line">npm WARN deprecated highlight.js@9.18.5: Support has ended for 9.x series. Upgrade to @latest</span><br></pre></td></tr></table></figure>
<blockquote>
<p>隐藏的问题在一个问题里说明。</p>
</blockquote>
<h4 id="ignore-scripts">3.<code>--ignore-scripts</code></h4>
<p>其实使用参考[4] 的方法（命令后面添加 <code>--ignore-scripts</code>
参数），确实也可以成功安装 <code>optipng-bin</code> 和
<code>gifsicle</code>，但不知道有没有其他影响。</p>
<blockquote>
<p><strong>更新</strong> 2021/10/30</p>
</blockquote>
<p>重装系统了，于是决定再来试一试，结果没有出现以上的问题，因为出现的其他五花八门的错，甚至：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install</span>                                    </span><br><span class="line">npm ERR! Unexpected token &lt; in JSON at position 0 while parsing near &#x27;&lt;!DOCTYPE html&gt;</span><br><span class="line">npm ERR! &lt;htm...&#x27;</span><br><span class="line"></span><br><span class="line">npm ERR! A complete log of this run can be found in:</span><br><span class="line">npm ERR!     /home/ym/.npm/_logs/2021-11-02T11_37_54_847Z-debug.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>感觉又回到了 17 年的 <code>npm</code>：</p>
<blockquote>
<p>你好，我们为你安装了七个包，卸载了十三个包。</p>
</blockquote>
<blockquote>
<p><strong>更新</strong> 2021/10/30</p>
</blockquote>
<p>没有上面那些乱七八糟的错误了，但是回到这个问题的最初状态，即
<code>gifsicle</code> 和 <code>optipng-bin</code> 的安装问题。</p>
<hr />
<p>参考： 1.<a
target="_blank" rel="noopener" href="https://github.com/p2227/p2227.github.io/issues/5">npm 提示 unable
to verify the first certificate 的解决小结 #5</a> 2.<a
target="_blank" rel="noopener" href="https://github.com/npm/npm/issues/20949">npm: unable to verify the
first certificate #20949</a> 3.<a
target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40033794/yarn-unable-to-verify-the-first-certificate/40350239#40350239">Yarn:
unable to verify the first certificate</a> 4.<a
target="_blank" rel="noopener" href="https://blog.csdn.net/feinifi/article/details/106680361">npm
install optipng-bin Failed at the optipng-bin@7.0.0 postinstall
script</a></p>
<h2 id="gulp-imagemin">9.<code>gulp-imagemin</code></h2>
<blockquote>
<p>2021/10/30</p>
</blockquote>
<p>在上述条件下，安装完成。然后执行 <code>npx hexo clean</code> 和
<code>npx hexo g</code>，没有什么问题，按照流程，接下来执行
<code>gulp</code>，压缩文件，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[22:38:16] Error in plugin &quot;gulp-imagemin&quot;</span><br><span class="line">Message:</span><br><span class="line">    spawn /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/imagemin-optipng/node_modules/optipng-bin/vendor/optipng ENOENT</span><br><span class="line">Details:</span><br><span class="line">    errno: -2</span><br><span class="line">    code: ENOENT</span><br><span class="line">    syscall: spawn /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/imagemin-optipng/node_modules/optipng-bin/vendor/optipng</span><br><span class="line">    path: /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/imagemin-optipng/node_modules/optipng-bin/vendor/optipng</span><br><span class="line">    spawnargs: -strip,all,-clobber,-o,3,-out,/tmp/a9f76343-d171-410a-a397-7c6be5040b24,-fix,/tmp/925435cc-4b38-4220-8d8f-fbc1abef0562</span><br><span class="line">    killed: false</span><br><span class="line">    stdout: </span><br><span class="line">    stderr: </span><br><span class="line">    failed: true</span><br><span class="line">    signal: null</span><br><span class="line">    cmd: /home/ym/Documents/gitproject/richardmyu.github.io/node_modules/imagemin-optipng/node_modules/optipng-bin/vendor/optipng -strip all -clobber -o 3 -out /tmp/a9f76343-d171-410a-a397-7c6be5040b24 -fix /tmp/925435cc-4b38-4220-8d8f-fbc1abef0562</span><br><span class="line">    timedOut: false</span><br><span class="line">    fileName: /home/ym/Documents/gitproject/richardmyu.github.io/public/images/apple-touch-icon-next.png</span><br><span class="line">    domainEmitter: [object Object]</span><br><span class="line">    domainThrown: false</span><br></pre></td></tr></table></figure>
<p>查看文件，发现 <code>vendor</code> 下没有
<code>optipng</code>，只有一个 <code>source</code> 目录。所以说升级
<code>node</code> 并没有解决 <code>gulp-imagemin</code> 的问题。</p>
<p>找了一圈，唯一有相同报错的，没有解决方案，只有一个不靠谱的卸载重装。<a
target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38499668/got-enoent-error-with-gulp-image">Got
ENOENT error with gulp-image</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有人说用 `cnpm` 可以，我就试了一下，确实可以</span></span><br><span class="line">npm uninstall --save-dev gulp-imagemin</span><br><span class="line">npm install -g cnpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">必须制定 7.1，因为新版本（8.0）改为 ESM</span></span><br><span class="line">cnpm install --save-dev gulp-imagemin@7.1</span><br></pre></td></tr></table></figure>
<p>安装过程中会提示有很多被废弃的，但现在真不想一个一个去换（有的会提示替代品，有的提示升级，其实升级也有风险，真不知道版本兼任有多少问题；有的就说废弃了，没了。。。:cry:）。</p>
<p>卸载以后使用 <code>cnpm</code>
安装就没有问题。所以，这是为什么呢？？？:confused::confused::confused:
:triumph::triumph::triumph:</p>
<p>为了解决这个问题，使用 <code>meld</code> 检测三种
<code>gulp-imagemin</code> 文件：</p>
<p>1.早期 win10 上安装的 <code>gulp-imagemin</code> -- win-gi;
2.当前时间用 <code>npm</code> 安装的 <code>gulp-imagemin</code> --
npm-gi; 3.当前时间用 <code>cnpm</code> 安装的 <code>gulp-imagemin</code>
-- cnpm-gi;</p>
<p>在 <code>package.json</code> 中，发现当前安装的 json
少了很多描述，并且将
<code>imagemin-gifsicle</code>、<code>imagemin-mozjpeg</code>、<code>imagemin-optipng</code>
和 <code>imagemin-svg</code>
从生产依赖移除，保留在可选依赖(optionsalDependences)中。cnpm-gi 相比
npm-gi，多了：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;__npminstall_done&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gulp-imagemin@7.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_resolved&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://registry.npmmirror.com/gulp-imagemin/download/gulp-imagemin-7.1.0.tgz&quot;</span></span><br></pre></td></tr></table></figure>
<p>其他文件基本一致，两份 <code>package.json</code> 均有上述区别。相对
npm-gi 来说，cnpm-gi 多了跟 <code>gulp-iamgemin</code>
相关的包的链接包。具体来说，就是 <code>node_modules</code>
中大部分包，都有对应到版本的以
<code>_package-name@xx@buffer-alloc-unsafe</code> 命名的包。</p>
<p>总之，暂时没有找出 <code>npm</code> 不行而 <code>cnpm</code>
可以的原因。</p>
<h2
id="warning-accessing-non-existent-property-xxx-of-module-exports-inside-circular-dependency">10.<code>Warning: Accessing non-existent property 'xxx' of module exports inside circular dependency</code></h2>
<blockquote>
<p>2021/10/30</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">INFO  Start processing</span><br><span class="line">(node:56494) Warning: Accessing non-existent property &#x27;lineno&#x27; of module exports inside circular dependency</span><br><span class="line">(Use `node --trace-warnings ...` to show where the warning was created)</span><br><span class="line">(node:56494) Warning: Accessing non-existent property &#x27;column&#x27; of module exports inside circular dependency</span><br><span class="line">(node:56494) Warning: Accessing non-existent property &#x27;filename&#x27; of module exports inside circular dependency</span><br><span class="line">(node:56494) Warning: Accessing non-existent property &#x27;lineno&#x27; of module exports inside circular dependency</span><br><span class="line">(node:56494) Warning: Accessing non-existent property &#x27;column&#x27; of module exports inside circular dependency</span><br><span class="line">(node:56494) Warning: Accessing non-existent property &#x27;filename&#x27; of module exports inside circular dependency</span><br></pre></td></tr></table></figure>
<p>没啥影响，就是看到不舒服。说好了，修复了，结果在高版本还是一样。切换到低版本，可以回避这个问题，但没必要。</p>
<hr />
<p>1.<a target="_blank" rel="noopener" href="https://github.com/stylus/stylus/issues/2534">NodeJS 14
warnings #2534</a> 2.<a
target="_blank" rel="noopener" href="https://github.com/hexojs/hexo-fs/pull/60">fix: compatible with
Node.js 14 #60</a> 3.<a
target="_blank" rel="noopener" href="https://github.com/stylus/stylus/pull/2538">Fix for Node v14
'Accessing non-existent property' errors #2538</a></p>
<h2 id="多端同步">11.多端同步</h2>
<blockquote>
<p>2021/11/04</p>
</blockquote>
<p>当前 HEXO 博客，实际是单项的，即本地修改上传。而在 github
上，是可以修改博客的 <code>.md</code>
文件的，这样本地就无法获取。多端同步，亦是同样的。在已知博客内容（本地内容经过处理的）是通过
<code>hexo-deployer-git</code>
自动推送的，所以我们还需要一种方法实现本地文件和远程文件的同步。一般有新建远程仓库的，也有通过分支的。</p>
<p>原本我是想用分支的，但看到 <a
target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/one-command-deployment#%E8%BF%99%E4%B8%80%E5%88%87%E6%98%AF%E5%A6%82%E4%BD%95%E5%8F%91%E7%94%9F%E7%9A%84%EF%BC%9F">hexo
官网--For 使用 Git
管理站点目录的用户</a>，感觉很认可，遂改为新仓库。</p>
<h2 id="husky">12.husky</h2>
<blockquote>
<p>2022/01/15</p>
</blockquote>
<p>之前为了多端写博客，弄了一个仓库来存储非 <code>public</code>
部分文件，这样一来，每次写完文章，一边要推送博客，一边要提交仓库，很麻烦。</p>
<p>基础的推送：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 编译</span><br><span class="line">hexo g -f</span><br><span class="line"></span><br><span class="line"># 压缩</span><br><span class="line">gulp</span><br><span class="line"></span><br><span class="line"># 推送</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>
<p>不如在 <code>package.json</code> 中，用一行命令搞定：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">&quot;pb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo g -f &amp;&amp; gulp &amp;&amp; hexo d&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>即便这样，每次，还是得分两步：推送，提交。但是同过
gitHook，可以自动完成推送。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 安装</span><br><span class="line">npm install husky -D</span><br><span class="line"># husky 初始化</span><br><span class="line">npx husky install</span><br><span class="line"># 创建 pre-commit hook</span><br><span class="line">npx husky add .husky/pre-commit &quot;npm run pb&quot;</span><br></pre></td></tr></table></figure>
<p>对 <code>package.json</code> 修改：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">&quot;pb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo g -f &amp;&amp; gulp &amp;&amp; hexo d&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;husky&quot;</span> <span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hooks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;pre-commit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run pb&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>之后，按照正常 git 流程就可以了。</p>
<p>当然，有些时候，可能会有些修改与文章无关，即不需要推送到博客上的，可以使用
<code>--no-verify</code> 跳过。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git commit --no-verify -m&quot;xxx&quot;</span><br></pre></td></tr></table></figure>
<h2 id="fatal-somethings-wrong.">13.FATAL Something's wrong.</h2>
<blockquote>
<p>2024/01/19</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">hexo:</span> <span class="number">7.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">hexo-cli:</span> <span class="number">4.3</span><span class="number">.1</span></span><br><span class="line"><span class="attr">os:</span> <span class="string">win32</span> <span class="number">10.0</span><span class="number">.22621</span></span><br><span class="line"><span class="attr">node:</span> <span class="number">20.11</span><span class="number">.0</span></span><br><span class="line"><span class="attr">hexo-theme-next:</span> <span class="number">8.19</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<p>没有动 <code>themes/next/_config.yml</code>，而是在根目录添加了
<code>_config.next.yml</code> 文件，对主题的修改在此处进行。</p>
<p>如何推送时报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INFO  Start processing</span><br><span class="line">FATAL Something&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">TypeError: Cannot read properties of undefined (reading &#x27;enable&#x27;)</span><br><span class="line">    at C:\mywork\remote_project\hexo-source\themes\next\scripts\filters\comment\valine.js:11:21</span><br><span class="line">    at Filter.execSync (C:\mywork\remote_project\hexo-source\node_modules\hexo\dist\extend\filter.js:72:36)</span><br><span class="line">    at Hexo.execFilterSync (C:\mywork\remote_project\hexo-source\node_modules\hexo\dist\hexo\index.js:394:35)</span><br><span class="line">    at module.exports (C:\mywork\remote_project\hexo-source\themes\next\scripts\events\lib\injects.js:58:8)</span><br><span class="line">    at Hexo.&lt;anonymous&gt; (C:\mywork\remote_project\hexo-source\themes\next\scripts\events\index.js:11:27)</span><br><span class="line">    at Hexo.tryCatcher (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\util.js:16:23)</span><br><span class="line">    at Hexo.&lt;anonymous&gt; (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\method.js:15:34)</span><br><span class="line">    at C:\mywork\remote_project\hexo-source\node_modules\hexo\dist\extend\filter.js:58:67</span><br><span class="line">    at tryCatcher (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\util.js:16:23)</span><br><span class="line">    at Object.gotValue (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\reduce.js:166:18)</span><br><span class="line">    at Object.gotAccum (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\reduce.js:155:25)</span><br><span class="line">    at Object.tryCatcher (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\util.js:16:23)</span><br><span class="line">    at Promise._settlePromiseFromHandler (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\promise.js:547:31)</span><br><span class="line">    at Promise._settlePromise (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\promise.js:604:18)</span><br><span class="line">    at Promise._settlePromiseCtx (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\promise.js:641:10)</span><br><span class="line">    at _drainQueueStep (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\async.js:97:12)</span><br></pre></td></tr></table></figure>
<p>根据报错信息，先去查看
<code>\themes\next\scripts\filters\comment\valine.js:11:21</code>
文件：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!theme.<span class="property">valine</span>.<span class="property">enable</span> || !theme.<span class="property">valine</span>.<span class="property">appid</span> || !theme.<span class="property">valine</span>.<span class="property">appkey</span>) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p>根据报错信息
<code>TypeError: Cannot read properties of undefined (reading 'enable')</code>，可以确定是
<code>theme.valine</code>
不存在，这时候需要去看看主题配置文件了（<code>themes/next/_config.yml</code>），然后确实没有找到
<code>valine</code> 相关信息，去官网<a
target="_blank" rel="noopener" href="https://github.com/next-theme/hexo-theme-next/">https://github.com/next-theme</a>查找，终于在
<a
target="_blank" rel="noopener" href="https://github.com/next-theme/hexo-theme-next/issues/4">【必读】更新说明及常见问题
#4</a>找到解释了：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">v8.1.0 移除 Valine</span><br><span class="line">Valine 使用 Leancloud 作为后端，是一个深受静态博客用户喜爱的评论系统。然而 Valine 暴露出了一些令人担忧的问题：</span><br><span class="line"></span><br><span class="line">NexT 团队曾多次收到关于 Valine 评论系统存在隐私数据泄露的反馈；</span><br><span class="line">Valine 自 1.4 版本起不再开源，发布的打包版本中存在未告知用户的百度统计代码；</span><br><span class="line">2020 年 11 月下旬出现了针对 Valine 的垃圾评论攻击；</span><br><span class="line">[<span class="string">CVE-2021-34801</span>](<span class="link">https://github.com/advisories/GHSA-p2c4-gxp4-j3xp</span>)</span><br><span class="line">考虑到这些问题已经严重影响到 NexT 用户的数据安全，我们决定将其移除，需要继续使用的用户请安装插件： https://github.com/next-theme/hexo-next-valine</span><br><span class="line">（插件的配置项使用驼峰命名，与 Valine 本身一致，需要注意将 appid 和 appkey 改为 appId 和 appKey）</span><br><span class="line">由于 Valine 不再开源，NexT 团队无法对其 Debug。如果在使用时出现任何问题，请在这里反馈： https://github.com/xCss/Valine/issues</span><br><span class="line">从 Valine 迁移到 Disqus： https://github.com/YunYouJun/valine-to-disqus</span><br></pre></td></tr></table></figure>
<p>至此，问题已解决。</p>
<p>1.主题配置文件（<code>_config.next.yml</code>）添加
<code>valine</code> 信息：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">valine:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>2.【不推荐】修改
<code>\themes\next\scripts\filters\comment\valine.js</code> 文件：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!theme.<span class="property">valine</span> || !theme.<span class="property">valine</span>.<span class="property">enable</span> || !theme.<span class="property">valine</span>.<span class="property">appid</span> || !theme.<span class="property">valine</span>.<span class="property">appkey</span>) <span class="keyword">return</span>;</span><br><span class="line"><span class="comment">// 注意，除了第 11 行，还有第 21 行</span></span><br></pre></td></tr></table></figure>
<p><strong>更新</strong>：</p>
<p>v8.1 版本还有 <code>valine.js</code> 文件，v8.2
已经移除了。直接安装新版本（v8.2及以上）的没有这个问题，但是从 v8.2
以下版本升级的，可能会有这个问题。</p>
<h2 id="增加相册功能">14.增加相册功能</h2>
<p>前一段时间，整理手机的时候，发现手机内的照片太多了，而那个时候也在写一些书摘，就想着，要不在博客上建立一个相册吧？在搭建和配置这个博客（Hexo
&amp;
Next）的时候，已经知道不支持相册功能，但实在是很想弄一个，于是上网搜搜看，看也没有可以借鉴的。</p>
<p>在看来了多个文章之后，选择了其中几篇比较详尽，功能比较符合需求的文章为借鉴，根据自己的实际情况，以及自己的需求，做出一些修改和调整，并在此记录下来。</p>
<hr />
<p>1.<a target="_blank" rel="noopener" href="https://houmin.cc/posts/d487dd02/">Hexo NexT
添加多级相册功能</a> 2.<a
target="_blank" rel="noopener" href="https://malizhi.cn/HexoAlbum/">搭建Hexo博客相册</a> 3.<a
target="_blank" rel="noopener" href="https://www.zywvvd.com/2020/04/22/next/23_get_image_info/get-image-info/">Next
-23- 添加相册系列 -3- 获取图像信息、保存为json文件并上传图像</a></p>
<h3 id="增加相册-tab">1.增加相册 tab</h3>
<p>控制台执行 <code>hexo new page "album"</code>，然后会在
<code>source</code> 文件看到 <code>album</code> 以及
<code>index.md</code> 文件。</p>
<p>然后在主题下的配置文件（<code>themes/next/_config.yml</code>）增加
tab:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="comment"># 新增</span></span><br><span class="line">  <span class="attr">album:</span> <span class="string">/album/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-camera</span></span><br></pre></td></tr></table></figure>
<p>图标可以自己更换，如果有语言切换，记得去主题的 <code>languages</code>
文件增加相册的对应语言词汇。</p>
<h3 id="一级相册">2.一级相册</h3>
<blockquote>
<p>单纯只要一级相册是挺简单的。但这里的一级相册，是要为二级相册做准备的。</p>
</blockquote>
<p>这里，我们使用模板来生成 album 页面，具体是在
<code>themes/next/layout</code> 下新建 <code>album.swig</code>
文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% extends &#x27;_layout.swig&#x27; %&#125;</span><br><span class="line">&#123;% import &#x27;_macro/sidebar.swig&#x27; as sidebar_template with context %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# 添加相册 title #&#125;</span><br><span class="line">&#123;% block title %&#125;&#123;&#123; page.title &#125;&#125; | &#123;&#123; title &#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;div class=&quot;posts-expand&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;post-block&quot; lang=&quot;&#123;&#123; page.lang or page.language or config.language &#125;&#125;&quot;&gt;</span><br><span class="line">            &#123;# 不想在相册页面显示 “相册”，则注释下一条代码 #&#125;</span><br><span class="line">            &#123;# &#123;% include &#x27;_partials/page/page-header.swig&#x27; %&#125; #&#125;</span><br><span class="line">            &lt;div class=&quot;post-body&#123;%- if page.direction and page.direction.toLowerCase() === &#x27;rtl&#x27; %&#125; rtl&#123;%- endif %&#125;&quot;&gt;</span><br><span class="line">                &#123;% if config.album %&#125;</span><br><span class="line">                &lt;div class=&quot;album-wrapper row&quot;&gt;</span><br><span class="line">                    &#123;% for gallery in config.album.gallery %&#125;</span><br><span class="line">                    &lt;div class=&quot;album-box&quot;&gt;</span><br><span class="line">                        &lt;a href=&quot;./&#123;&#123; gallery.name &#125;&#125;&quot; class=&quot;album-item&quot;&gt;</span><br><span class="line">                            &lt;div class=&quot;album-cover-box&quot; style=&quot;background-image: url(&#123;&#123; config.album.image_bed &#125;&#125;/&#123;&#123; gallery.name &#125;&#125;/thumbnail/&#123;&#123; gallery.cover &#125;&#125;);&quot;&gt;</span><br><span class="line">                            &lt;/div&gt;</span><br><span class="line">                            &lt;p class=&quot;album-name&quot;&gt;</span><br><span class="line">                                &#123;&#123; gallery.name &#125;&#125;</span><br><span class="line">                            &lt;/p&gt;</span><br><span class="line">                        &lt;/a&gt;</span><br><span class="line">                        &lt;p class=&quot;album-description&quot;&gt;</span><br><span class="line">                            &#123;&#123; gallery.description &#125;&#125;</span><br><span class="line">                        &lt;p&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block sidebar %&#125;</span><br><span class="line">  &#123;&#123; sidebar_template.render(true) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>细节上，可以根据自己的实际需求进行修改调整。然后要在<strong>站点</strong>配置文件(<code>_config.yml</code>)中，添加相册的信息：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">album:</span></span><br><span class="line">  <span class="attr">imageBed:</span> <span class="string">https://xxx.xx.com/album</span></span><br><span class="line">  <span class="attr">gallery:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">      <span class="attr">cover:</span> <span class="string">&#x27;xxx.jpg&#x27;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&#x27;xx...xx&#x27;</span></span><br><span class="line">      <span class="attr">created:</span> <span class="string">&#x27;xxxx-xx-xx&#x27;</span></span><br></pre></td></tr></table></figure>
<p>对于相册而已，这里只是生成了 html 页面，如有需要你可以根据 css
来定制对应的样式。这里 css
数据放在了<code>souce/_data/styles.styl</code> 中。</p>
<p>最后修改 <code>source/album/index.md</code> 文件：</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">date: xxxx-xx-xx xx:xx:xx</span><br><span class="line">layout: album</span><br><span class="line"><span class="section">title: &#x27;相册&#x27;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>
<p><code>layout: album</code> 用来指定使用 <code>album.swig</code>
来渲染出相册的 HTML 页面。</p>
<h3 id="二级相册">3.二级相册</h3>
<p>在 <code>source/album</code> 下，创建 gallery
目录，具体是指，根据站点配置信息，建立对应的图册目录。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">album:</span></span><br><span class="line">  <span class="attr">imageBed:</span> <span class="string">https://xxx.xx.com/album</span></span><br><span class="line">  <span class="attr">gallery:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;flowers&#x27;</span></span><br><span class="line">      <span class="attr">cover:</span> <span class="string">&#x27;xxx.jpg&#x27;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&#x27;xx...xx&#x27;</span></span><br><span class="line">      <span class="attr">created:</span> <span class="string">&#x27;xxxx-xx-xx&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;sky&#x27;</span></span><br><span class="line">      <span class="attr">cover:</span> <span class="string">&#x27;xxx.jpg&#x27;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&#x27;xx...xx&#x27;</span></span><br><span class="line">      <span class="attr">created:</span> <span class="string">&#x27;xxxx-xx-xx&#x27;</span></span><br></pre></td></tr></table></figure>
<p>对应 gallery :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|-- album</span><br><span class="line">|    |</span><br><span class="line">|    |-- index.md</span><br><span class="line">|    |</span><br><span class="line">|    |-- flowers</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- data.json</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- index.md</span><br><span class="line">|    |    |</span><br><span class="line">|    |</span><br><span class="line">|    |-- sky</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- data.json</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- index.md</span><br><span class="line">|    |    |</span><br><span class="line">|    |</span><br><span class="line">|    |-- ...</span><br><span class="line">|</span><br></pre></td></tr></table></figure>
<p>下面是描述相册的 JSON 文件，可以通过 Python
脚本自动生成和更新（后面有讲述）。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flowers&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cover&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx...xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx-xx-xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;imageBed&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://xxx.xxcom/album&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-11&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;caption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx....xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx-xx-xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx,xxx,xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;width&quot;</span><span class="punctuation">:</span> <span class="number">6400</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">4000</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>下面是 gallery 的 <code>index.md</code> 文件：</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">date: xxxx-xx-xx xx:xx:xx</span><br><span class="line">fancybox: false</span><br><span class="line">layout: gallery</span><br><span class="line">title: &#x27;flowers&#x27;</span><br><span class="line"><span class="section">galleryName: &#x27;flowers&#x27;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>
<p>接下来，就要编写 gallery 的模板了。跟一级相册一样，还是在在
<code>themes/next/layout</code> 下新建 <code>gallery.swig</code>
文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% extends &#x27;_layout.swig&#x27; %&#125;</span><br><span class="line">&#123;% import &#x27;_macro/sidebar.swig&#x27; as sidebar_template with context %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;&#123;&#123; page.title &#125;&#125; | &#123;&#123; title &#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;posts-expand&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;post-block&quot; lang=&quot;&#123;&#123; page.lang or page.language or config.language &#125;&#125;&quot;&gt;</span><br><span class="line">            &#123;# &#123;% include &#x27;_partials/page/page-header.swig&#x27; %&#125; #&#125;</span><br><span class="line">            &lt;div class=&quot;post-body&#123;%- if page.direction and page.direction.toLowerCase() === &#x27;rtl&#x27; %&#125; rtl&#123;%- endif %&#125;&quot;&gt;</span><br><span class="line">                &lt;link rel=&quot;stylesheet&quot; href=&quot;/lib/album/photoswipe.css&quot;&gt;</span><br><span class="line">                &lt;link rel=&quot;stylesheet&quot; href=&quot;/lib/album/default-skin/default-skin.css&quot;&gt;</span><br><span class="line"></span><br><span class="line">                &#123;# gallery body #&#125;</span><br><span class="line"></span><br><span class="line">                &lt;div class=&quot;gallery&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;gallery-description&quot;&gt;</span><br><span class="line">                        &lt;p id=&quot;gallery-description&quot;&gt;这里是相册描述&lt;/p&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">                    &lt;div class=&quot;instagram itemscope&quot;&gt;</span><br><span class="line">                        &lt;a href=&quot;https://richyu.gitee.io/&quot; target=&quot;_blank&quot; class=&quot;open-ins&quot;&gt;图片正在加载中…&lt;/a&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &#123;# gallery body end #&#125;</span><br><span class="line"></span><br><span class="line">                &#123;# &lt;!-- Core JS file --&gt; #&#125;</span><br><span class="line">                &lt;script src=&quot;/lib/album/photoswipe.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">                &#123;# &lt;!-- UI JS file --&gt; #&#125;</span><br><span class="line">                &lt;script src=&quot;/lib/album/photoswipe-ui-default.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">                &#123;# &lt;!-- gallery.js --&gt; #&#125;</span><br><span class="line">                &lt;script&gt;</span><br><span class="line">                    (function() &#123;</span><br><span class="line">                        var loadScript = function(path) &#123;</span><br><span class="line">                        var $script = document.createElement(&#x27;script&#x27;)</span><br><span class="line">                        document.getElementsByTagName(&#x27;body&#x27;)[0].appendChild($script)</span><br><span class="line">                        $script.setAttribute(&#x27;src&#x27;, path)</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTimeout(function() &#123;</span><br><span class="line">                            loadScript(&#x27;/lib/album/gallery.min.js&#x27;)</span><br><span class="line">                        &#125;, 0)</span><br><span class="line">                    &#125;)()</span><br><span class="line">                &lt;/script&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &#123;# &#123;% include &#x27;_partials/page/breadcrumb.swig&#x27; %&#125; #&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &#123;# &lt;!-- Root element of PhotoSwipe. Must have class pswp. --&gt; #&#125;</span><br><span class="line">    &lt;div class=&quot;pswp&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot; aria-hidden=&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &#123;# &lt;!-- Background of PhotoSwipe.</span><br><span class="line">         It&#x27;s a separate element, as animating opacity is faster than rgba(). --&gt; #&#125;</span><br><span class="line">        &lt;div class=&quot;pswp__bg&quot;&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &#123;# &lt;!-- Slides wrapper with overflow:hidden. --&gt; #&#125;</span><br><span class="line">        &lt;div class=&quot;pswp__scroll-wrap&quot;&gt;</span><br><span class="line"></span><br><span class="line">            &#123;# &lt;!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. --&gt; #&#125;</span><br><span class="line">            &#123;# &lt;!-- don&#x27;t modify these 3 pswp__item elements, data is added later on. --&gt; #&#125;</span><br><span class="line">            &lt;div class=&quot;pswp__container&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;pswp__item&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;pswp__item&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;pswp__item&quot;&gt;&lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &#123;# &lt;!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. --&gt; #&#125;</span><br><span class="line">            &lt;div class=&quot;pswp__ui pswp__ui--hidden&quot;&gt;</span><br><span class="line"></span><br><span class="line">                &lt;div class=&quot;pswp__top-bar&quot;&gt;</span><br><span class="line"></span><br><span class="line">                    &#123;# &lt;!--  Controls are self-explanatory. Order can be changed. --&gt; #&#125;</span><br><span class="line">                    &lt;div class=&quot;pswp__counter&quot;&gt;&lt;/div&gt;</span><br><span class="line">                    &lt;button class=&quot;pswp__button pswp__button--close&quot; title=&quot;Close (Esc)&quot;&gt;&lt;/button&gt;</span><br><span class="line">                    &#123;# &lt;button class=&quot;pswp__button pswp__button--share&quot; title=&quot;Share&quot;&gt;&lt;/button&gt; #&#125;</span><br><span class="line">                    &lt;button class=&quot;pswp__button pswp__button--fs&quot; title=&quot;Toggle fullscreen&quot;&gt;&lt;/button&gt;</span><br><span class="line">                    &lt;button class=&quot;pswp__button pswp__button--zoom&quot; title=&quot;Zoom in/out&quot;&gt;&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">                    &#123;# &lt;!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR --&gt; #&#125;</span><br><span class="line">                    &#123;# &lt;!-- element will get class pswp__preloader--active when preloader is running --&gt; #&#125;</span><br><span class="line">                    &lt;div class=&quot;pswp__preloader&quot;&gt;</span><br><span class="line">                        &lt;div class=&quot;pswp__preloader__icn&quot;&gt;</span><br><span class="line">                            &lt;div class=&quot;pswp__preloader__cut&quot;&gt;</span><br><span class="line">                                &lt;div class=&quot;pswp__preloader__donut&quot;&gt;&lt;/div&gt;</span><br><span class="line">                            &lt;/div&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">                &lt;div class=&quot;pswp__share-modal pswp__share-modal--hidden pswp__single-tap&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;pswp__share-tooltip&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">                &lt;button class=&quot;pswp__button pswp__button--arrow--left&quot; title=&quot;Previous (arrow left)&quot;&gt;&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">                &lt;button class=&quot;pswp__button pswp__button--arrow--right&quot; title=&quot;Next (arrow right)&quot;&gt;&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">                &lt;div class=&quot;pswp__caption&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;pswp__caption__center&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block sidebar %&#125;</span><br><span class="line">  &#123;&#123; sidebar_template.render(true) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，页面基本完成，剩下的就是编写 <code>gallery.js</code>
了。</p>
<h3 id="编写脚本">4.编写脚本</h3>
<p>在 <code>themes/next/source/lib</code> 下，新建 album
目录，创建一下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|</span><br><span class="line">|-- album</span><br><span class="line">|    |</span><br><span class="line">|    |-- assets</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- empty,png</span><br><span class="line">|    |    |</span><br><span class="line">|    |</span><br><span class="line">|    |-- default-skin</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- default-skin.css</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- default-skin.png</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- default-skin.svg</span><br><span class="line">|    |    |</span><br><span class="line">|    |    |-- preloader.gif</span><br><span class="line">|    |    |</span><br><span class="line">|    |</span><br><span class="line">|    |-- gallery.js</span><br><span class="line">|    |</span><br><span class="line">|    |-- handler_photoswipe.js</span><br><span class="line">|    |</span><br><span class="line">|    |-- photoswipe-ui-default.min.js</span><br><span class="line">|    |</span><br><span class="line">|    |-- photoswipe.css</span><br><span class="line">|    |</span><br><span class="line">|    |-- photoswipe.min.js</span><br><span class="line">|    |</span><br><span class="line">|</span><br></pre></td></tr></table></figure>
<p>以上这些图片以及脚本均可以在 <a
target="_blank" rel="noopener" href="https://github.com/richardmyu/richardmyu.github.io/tree/main/lib/album">https://github.com/richardmyu/richardmyu.github.io/tree/main/lib/album</a>
中找到。</p>
<p>其中一个重点在 <code>gallery.js</code> 文件中。</p>
<p>这是参考文章中的脚本：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;lazyloadjs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> photoswipe = <span class="built_in">require</span>(<span class="string">&quot;./handler_photoswipe.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> view = <span class="title function_">_interopRequireDefault</span>(photoswipe.<span class="property">viewer</span>);</span><br><span class="line"><span class="keyword">var</span> galleryPath = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>;</span><br><span class="line"><span class="keyword">var</span> galleryName = galleryPath.<span class="title function_">split</span>(<span class="string">&quot;/&quot;</span>)[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">var</span> dataUrl = <span class="string">&#x27;/album/&#x27;</span> + galleryName + <span class="string">&#x27;/data.json&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> dataJSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_interopRequireDefault</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> obj &amp;&amp; obj.<span class="property">__esModule</span> ? obj : &#123;</span><br><span class="line">    <span class="attr">default</span>: obj</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> render = <span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">response</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> imageBed = response[<span class="string">&quot;image_bed&quot;</span>];</span><br><span class="line">  <span class="keyword">var</span> description = response[<span class="string">&quot;description&quot;</span>];</span><br><span class="line">  <span class="keyword">var</span> items = response[<span class="string">&quot;items&quot;</span>];</span><br><span class="line">  <span class="keyword">var</span> ulTmpl = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> item <span class="keyword">of</span> items) &#123;</span><br><span class="line">    <span class="keyword">var</span> liTmpl = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> date = item[<span class="string">&#x27;date&#x27;</span>]</span><br><span class="line">    <span class="keyword">var</span> year = date.<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> month = date.<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>)[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> img <span class="keyword">of</span> item[<span class="string">&quot;images&quot;</span>]) &#123;</span><br><span class="line">      <span class="keyword">var</span> thumbnail = imageBed + <span class="string">&#x27;/&#x27;</span> + galleryName + <span class="string">&quot;/thumbnail/&quot;</span> + img.<span class="property">name</span>;</span><br><span class="line">      <span class="keyword">var</span> artwork = imageBed + <span class="string">&#x27;/&#x27;</span> + galleryName + <span class="string">&quot;/artwork/&quot;</span> + img.<span class="property">name</span>;</span><br><span class="line">      <span class="keyword">var</span> caption = img.<span class="property">caption</span>;</span><br><span class="line">      <span class="keyword">var</span> address = img.<span class="property">address</span></span><br><span class="line">      <span class="keyword">var</span> width = img.<span class="property">width</span>;</span><br><span class="line">      <span class="keyword">var</span> height = img.<span class="property">height</span>;</span><br><span class="line"></span><br><span class="line">      liTmpl += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;figure class=&quot;thumb&quot; itemprop=&quot;associatedMedia&quot; itemscope=&quot;&quot; itemtype=&quot;http://schema.org/ImageObject&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;a href=&quot;<span class="subst">$&#123;artwork&#125;</span>&quot; itemprop=&quot;contentUrl&quot; data-size=&quot;<span class="subst">$&#123;width&#125;</span>x<span class="subst">$&#123;height&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;img class=&quot;reward-img&quot; data-src=&quot;<span class="subst">$&#123;thumbnail&#125;</span>&quot; src=&quot;/lib/album/assets/empty.png&quot; itemprop=&quot;thumbnail&quot; onload=&quot;lzld(this)&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;figcaption style=&quot;display:none;&quot; itemprop=&quot;caption description&quot;&gt;<span class="subst">$&#123;address || caption&#125;</span>&lt;/figcaption&gt;</span></span><br><span class="line"><span class="string">      &lt;/figure&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ulTmpl += <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;section class=&quot;archives album&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;h3 class=&quot;timeline&quot;&gt;<span class="subst">$&#123;year&#125;</span> 年 <span class="subst">$&#123;month&#125;</span> 月&lt;/h3&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;img-box&quot;&gt;<span class="subst">$&#123;liTmpl&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/section&gt;`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.instagram&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">`&lt;div class=<span class="subst">$&#123;photoswipe.galleryClass&#125;</span> itemscope=&quot;&quot; itemtype=&quot;http://schema.org/ImageGallery&quot;&gt;<span class="subst">$&#123;ulTmpl&#125;</span>&lt;/div&gt;`</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#gallery-description&#x27;</span>).<span class="property">innerHTML</span> = description;</span><br><span class="line"></span><br><span class="line">  view.<span class="property">default</span>.<span class="title function_">init</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadData</span>(<span class="params">render</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!dataJSON) &#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, dataUrl, <span class="literal">true</span>);</span><br><span class="line">    xhr.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> &gt;= <span class="number">200</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">status</span> &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        dataJSON = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">response</span>);</span><br><span class="line">        <span class="title function_">render</span>(dataJSON);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="variable language_">this</span>.<span class="property">statusText</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="variable language_">this</span>.<span class="property">statusText</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.<span class="title function_">send</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(dataJSON);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Gallery</span> = &#123;</span><br><span class="line">  <span class="attr">init</span>: <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">loadData</span>(<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">      <span class="title function_">render</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Gallery</span>.<span class="title function_">init</span>();</span><br></pre></td></tr></table></figure>
<p>需要注意的一点是：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ulTmpl += <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;section class=&quot;archives album&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;h3 class=&quot;timeline&quot;&gt;<span class="subst">$&#123;year&#125;</span> 年 <span class="subst">$&#123;month&#125;</span> 月&lt;/h3&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;img-box&quot;&gt;<span class="subst">$&#123;liTmpl&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/section&gt;`</span>;</span><br></pre></td></tr></table></figure>
<p>从 <code>&lt;section class="archives album"&gt;</code> 到
<code>$&#123;liTmpl&#125;</code>，中间只能嵌套一层；若想要嵌套多层，要修改
<code>handler_photoswipe.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> parseThumbnailElements = <span class="keyword">function</span> <span class="title function_">parseThumbnailElements</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="comment">// 两次获取父节点，限定了最多只能嵌套一层，</span></span><br><span class="line">    <span class="comment">// 超过一层（多层情况也一致），会因为祖父节点定位在单个照片组之内，</span></span><br><span class="line">    <span class="comment">// 使得 photoswipe 将照片组甚至单个照片视为一个相册，</span></span><br><span class="line">    <span class="comment">// 从而造成点击的照片在“相册”中的索引与当前与全局获取图片的索引不一致</span></span><br><span class="line">    <span class="comment">// 结果就是点击图片，放大的是另一张图片</span></span><br><span class="line">    el = el.<span class="property">parentNode</span>.<span class="property">parentNode</span>;</span><br><span class="line">    <span class="keyword">var</span> thumbElements = el.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;thumb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取该页面全部图片 `thumb` </span></span><br><span class="line">childNodes = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;thumb&#x27;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>放大图片的规则：当前点击照片全局索引 a，当前“相册” 照片数
x，放大的图片在该“相册”内的索引是 a；自然会有 a &gt; x
的情况，那结果就是取“相册”的第一张照片。</p>
</blockquote>
<h3 id="自动化-json">5.自动化 JSON</h3>
<p>上面说到相册的数据是从 <code>data.json</code>
读取的，如果照片或者相册比较多，那么写 JSON 会很无聊的，所以我们使用
Python 来完成这个工作。</p>
<blockquote>
<p>因为我使用了 Gitee 的仓库来作为图床，所以便也把 python
脚本也写在了图床仓库里。</p>
</blockquote>
<p>这一部分参考 <a target="_blank" rel="noopener" href="https://houmin.cc/posts/d487dd02/">Hexo NexT
添加多级相册功能</a>
就可以了，实际也可以根据自己的需求，进行部分修改和调整，比如我就增加了批量添加图片，解析
GPS
获取地址以及拍摄日期（个人觉得从图片名称获取日期不确定性比较大，甚至可能得修改图片名称）。</p>
<blockquote>
<p>为了获取 Exif
信息，肯定得放上原图，但原图如果上传到图库，也不合适（:smirk:那你还不是主动提供了地址。。。:joy::joy::joy:），所以我多增加了一个文件，用来存放原图，且不上传的。</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset_orientation</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    处理图片的自动（PIL处理回发生）旋转</span></span><br><span class="line"><span class="string">    增加对 width / height 的调换处理</span></span><br><span class="line"><span class="string">    https://cloud.tencent.com/developer/article/1523050</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    exif_orientation_tag = <span class="number">274</span></span><br><span class="line">    w, h = img.size</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(img, <span class="string">&quot;_getexif&quot;</span>) <span class="keyword">and</span> <span class="built_in">isinstance</span>(img._getexif(), <span class="built_in">dict</span>) <span class="keyword">and</span> exif_orientation_tag <span class="keyword">in</span> img._getexif():</span><br><span class="line">        exif_data = img._getexif()</span><br><span class="line">        orientation = exif_data[exif_orientation_tag]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Handle EXIF Orientation</span></span><br><span class="line">        <span class="keyword">if</span> orientation == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># Normal image - nothing to do!</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># Mirrored left to right</span></span><br><span class="line">            <span class="comment"># transpose 翻转</span></span><br><span class="line">            img = img.transpose(Image.FLIP_LEFT_RIGHT)</span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># Rotated 180 degrees</span></span><br><span class="line">            img = img.rotate(<span class="number">180</span>)</span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">4</span>:</span><br><span class="line">            <span class="comment"># Mirrored top to bottom</span></span><br><span class="line">            img = img.rotate(<span class="number">180</span>).transpose(Image.FLIP_LEFT_RIGHT)</span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">5</span>:</span><br><span class="line">            <span class="comment"># Mirrored along top-left diagonal</span></span><br><span class="line">            img = img.rotate(-<span class="number">90</span>, expand=<span class="literal">True</span>).transpose(Image.FLIP_LEFT_RIGHT)</span><br><span class="line">            w, h = h, w</span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">6</span>:</span><br><span class="line">            <span class="comment"># Rotated 90 degrees</span></span><br><span class="line">            img = img.rotate(-<span class="number">90</span>, expand=<span class="literal">True</span>)</span><br><span class="line">            w, h = h, w</span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">7</span>:</span><br><span class="line">            <span class="comment"># Mirrored along top-right diagonal</span></span><br><span class="line">            img = img.rotate(<span class="number">90</span>, expand=<span class="literal">True</span>).transpose(Image.FLIP_LEFT_RIGHT)</span><br><span class="line">            w, h = h, w</span><br><span class="line">        <span class="keyword">elif</span> orientation == <span class="number">8</span>:</span><br><span class="line">            <span class="comment"># Rotated 270 degrees</span></span><br><span class="line">            img = img.rotate(<span class="number">90</span>, expand=<span class="literal">True</span>)</span><br><span class="line">            w, h = h, w</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: img,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: (w, h)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_geocoder</span>(<span class="params">geolocator, lat_lon, sleep_sec=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据经纬度，计算区域</span></span><br><span class="line"><span class="string">    https://www.pythonheidong.com/blog/article/680556/d9bf76d691415de282f1/</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 反向地理编码</span></span><br><span class="line">        <span class="keyword">return</span> geolocator.reverse(lat_lon)</span><br><span class="line">    <span class="keyword">except</span> GeocoderTimedOut:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Timeout: GeocoderTimedOut Retrying...&#x27;</span>)</span><br><span class="line">        time.sleep(randint(<span class="number">2</span> * <span class="number">100</span>, sleep_sec * <span class="number">100</span>) / <span class="number">50</span>)</span><br><span class="line">        <span class="keyword">return</span> AlbumTool.reverse_geocoder(geolocator, lat_lon, sleep_sec)</span><br><span class="line">    <span class="keyword">except</span> GeocoderServiceError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;CONNECTION REFUSED: GeocoderServiceError encountered.&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ERROR: Terminating due to exception &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(e))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_exif</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取图片的经纬度以及拍摄时间等信息</span></span><br><span class="line"><span class="string">    https://zhuanlan.zhihu.com/p/98460548</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loading and Resolving: &quot;</span> + img)</span><br><span class="line">    f = <span class="built_in">open</span>(img, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    image_map = exifread.process_file(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 图片的经度</span></span><br><span class="line">        img_longitude_ref = image_map[<span class="string">&quot;GPS GPSLongitudeRef&quot;</span>].printable</span><br><span class="line">        img_longitude = image_map[<span class="string">&quot;GPS GPSLongitude&quot;</span>].printable[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;,&quot;</span>).split(</span><br><span class="line">            <span class="string">&quot;,&quot;</span>)</span><br><span class="line">        img_longitude = <span class="built_in">float</span>(img_longitude[<span class="number">0</span>]) + <span class="built_in">float</span>(img_longitude[<span class="number">1</span>]) / <span class="number">60</span> + <span class="built_in">float</span>(</span><br><span class="line">            img_longitude[<span class="number">2</span>]) / <span class="built_in">float</span>(img_longitude[<span class="number">3</span>]) / <span class="number">3600</span></span><br><span class="line">        <span class="keyword">if</span> img_longitude_ref != <span class="string">&quot;E&quot;</span>:</span><br><span class="line">            img_longitude = img_longitude * (-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 图片的纬度</span></span><br><span class="line">        img_latitude_ref = image_map[<span class="string">&quot;GPS GPSLatitudeRef&quot;</span>].printable</span><br><span class="line">        img_latitude = image_map[<span class="string">&quot;GPS GPSLatitude&quot;</span>].printable[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;,&quot;</span>).split(</span><br><span class="line">            <span class="string">&quot;,&quot;</span>)</span><br><span class="line">        img_latitude = <span class="built_in">float</span>(img_latitude[<span class="number">0</span>]) + <span class="built_in">float</span>(img_latitude[<span class="number">1</span>]) / <span class="number">60</span> + <span class="built_in">float</span>(img_latitude[<span class="number">2</span>]) / <span class="built_in">float</span>(</span><br><span class="line">            img_latitude[<span class="number">3</span>]) / <span class="number">3600</span></span><br><span class="line">        <span class="keyword">if</span> img_latitude_ref != <span class="string">&quot;N&quot;</span>:</span><br><span class="line">            img_latitude = img_latitude * (-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ERROR: 图片中不包含 Gps 信息&#x27;</span>)</span><br><span class="line">        img_latitude = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        img_longitude = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 照片拍摄时间</span></span><br><span class="line">    img_create_date = image_map[<span class="string">&quot;Image DateTime&quot;</span>].printable[:<span class="number">10</span>].replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;-&quot;</span>)</span><br><span class="line"></span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">    location = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> img_latitude != <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> img_longitude != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        reverse_value = <span class="built_in">str</span>(img_latitude) + <span class="string">&#x27;, &#x27;</span> + <span class="built_in">str</span>(img_longitude)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化 Nominatim() 时传入新的 user-agent 值，避开样例值</span></span><br><span class="line">        user_agent = <span class="string">&#x27;my_blog_agent_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(randint(<span class="number">10000</span>, <span class="number">99999</span>))</span><br><span class="line">        geolocator = Nominatim(user_agent=user_agent)</span><br><span class="line">        location = AlbumTool.reverse_geocoder(geolocator, reverse_value)</span><br><span class="line"></span><br><span class="line">    address = location <span class="keyword">and</span> location.address <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    info = &#123;</span><br><span class="line">        <span class="string">&#x27;address&#x27;</span>: address,  <span class="comment"># 地址</span></span><br><span class="line">        <span class="string">&#x27;date&#x27;</span>: img_create_date  <span class="comment"># 日期</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br></pre></td></tr></table></figure>
<p>批量添加很简单就不说了。目前为止，相册部分算是基本完工了。效果见 <a
target="_blank" rel="noopener" href="https://richyu.gitee.io/album/">album</a>。</p>
<h5 id="补充">补充</h5>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(self.data_json) <span class="keyword">as</span> json_file:</span><br><span class="line">    data = json.load(json_file)</span><br><span class="line">    items =  data[<span class="string">&quot;items&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>这行代码可能会二次读取 JSON
时，造成乱码，解决方法就是指定读取格式：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(self.data_json, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> json_file</span><br></pre></td></tr></table></figure>
<h2
id="themenext_config.yml-minify-配置问题">15.<code>theme/next/_config.yml minify 配置问题</code></h2>
<p>今天手贱，修改了 <code>theme/next/_config.yml</code> 的配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Allow to cache content generation.</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove unnecessary files after hexo generate.</span></span><br><span class="line"><span class="comment">#minify: false</span></span><br><span class="line"><span class="attr">minify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>结果推送时报错了：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NexT version 8.19.0</span><br><span class="line">Documentation: https://theme-next.js.org</span><br><span class="line">========================================</span><br><span class="line">INFO  Start processing</span><br><span class="line">FATAL Something&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">TypeError: Cannot read properties of null (reading &#x27;style&#x27;)</span><br><span class="line">at Hexo.&lt;anonymous&gt; (C:\mywork\remote_project\hexo-source\themes\next\scripts\filters\minify.js:39:22)</span><br><span class="line">at Hexo.tryCatcher (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\util.js:16:23)</span><br><span class="line">at Hexo.&lt;anonymous&gt; (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\method.js:15:34)</span><br><span class="line">at C:\mywork\remote_project\hexo-source\node_modules\hexo\dist\extend\filter.js:58:67</span><br><span class="line">at tryCatcher (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\util.js:16:23)</span><br><span class="line">at Object.gotValue (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\reduce.js:166:18)</span><br><span class="line">at Object.gotAccum (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\reduce.js:155:25)</span><br><span class="line">at Object.tryCatcher (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\util.js:16:23)</span><br><span class="line">at Promise._settlePromiseFromHandler (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\promise.js:547:31)</span><br><span class="line">at Promise._settlePromise (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\promise.js:604:18)</span><br><span class="line">at Promise._settlePromiseCtx (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\promise.js:641:10)</span><br><span class="line">at _drainQueueStep (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\async.js:97:12)</span><br><span class="line">at _drainQueue (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\async.js:86:9)</span><br><span class="line">at Async._drainQueues (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\async.js:102:5)</span><br><span class="line">at Async.drainQueues [as _onImmediate] (C:\mywork\remote_project\hexo-source\node_modules\bluebird\js\release\async.js:15:14)</span><br><span class="line">at process.processImmediate (node:internal/timers:483:21)</span><br><span class="line">husky - pre-commit hook exited with code 2 (error)</span><br></pre></td></tr></table></figure>
<p>改回 <code>false</code> 后就正常了。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>yum
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://richardmyu.github.io/posts/fb53055d/" title="Hexo + Next - 个人博客配置问题">https://richardmyu.github.io/posts/fb53055d/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/fe768942/" rel="prev" title="python 规范 -autopep8 安装记录">
                  <i class="fa fa-angle-left"></i> python 规范 -autopep8 安装记录
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/f607b4cb/" rel="next" title="【书】瓦尔登湖">
                  【书】瓦尔登湖 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">yum</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

<script src="/js/highlight.min.js"></script>
<script>
  $(function(){
    $('pre code').each((i, el) => {
    hljs.highlightElement(el);
  });
</script>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
